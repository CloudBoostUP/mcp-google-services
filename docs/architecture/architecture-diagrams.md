# Google MCP Server Architecture Diagrams

## System Architecture Overview

```
┌─────────────────────────────────────────────────────────────┐
│                    MCP Server Interface                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   Tool Registry │  │  Request Router  │  │ Error Handler│ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  Core Services Layer                                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│  │    Auth     │ │    Rate     │ │  Scheduler  │ │ Config  │ │
│  │  Manager    │ │  Limiter    │ │             │ │ Manager │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
├─────────────────────────────────────────────────────────────┤
│  Service Integration Layer                                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│  │   Gmail     │ │   Drive     │ │  Calendar   │ │ Future │ │
│  │  Service    │ │  Service    │ │  Service    │ │Services│ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
├─────────────────────────────────────────────────────────────┤
│  Data Processing Layer                                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│  │    MBOX     │ │    JSON     │ │   Email     │ │ Format │ │
│  │ Generator   │ │ Exporter    │ │  Parser     │ │Converters│ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
├─────────────────────────────────────────────────────────────┤
│  Storage & Persistence Layer                               │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │
│  │   File     │ │   State     │ │   Backup    │ │ Logging │ │
│  │  Storage   │ │ Management  │ │ Metadata    │ │ System  │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## Gmail Service Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Gmail Service Layer                     │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Gmail Backup Service                      │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │ Incremental │ │   Full      │ │    Resume       │   │ │
│  │  │   Backup    │ │  Backup     │ │   Manager       │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Gmail API Client                          │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │  Messages   │ │   Labels    │ │    Batch        │   │ │
│  │  │   API       │ │    API      │ │   Operations    │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Gmail Export Service                      │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │    MBOX     │ │    JSON     │ │    EML          │   │ │
│  │  │ Generator   │ │ Exporter    │ │ Exporter        │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## Data Flow Architecture

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│    MCP      │    │   Gmail     │    │   Google    │
│  Client     │───▶│   API       │───▶│   Gmail    │
│             │    │  Client     │    │  Service   │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Request   │    │   Rate      │    │  Messages   │
│  Handler    │    │ Limiter     │    │   Data      │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Backup    │    │   Email     │    │   MBOX      │
│  Service    │    │  Parser     │    │ Generator   │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Storage    │    │   State     │    │   Backup    │
│ Manager     │    │ Manager     │    │   Files     │
└─────────────┘    └─────────────┘    └─────────────┘
```

## Authentication Flow

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│    User     │    │   MCP       │    │   Google    │
│             │    │  Server     │    │   OAuth     │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       │ 1. Request Auth   │                   │
       ├──────────────────▶│                   │
       │                   │ 2. OAuth URL     │
       │                   ├──────────────────▶│
       │                   │ 3. Auth URL      │
       │                   ◀──────────────────┤
       │ 4. Redirect       │                   │
       ◀──────────────────┤                   │
       │                   │                   │
       │ 5. User Login     │                   │
       ├──────────────────▶│                   │
       │                   │ 6. Auth Code     │
       │                   ├──────────────────▶│
       │                   │ 7. Access Token  │
       │                   ◀──────────────────┤
       │ 8. Success        │                   │
       ◀──────────────────┤                   │
```

## Backup Process Flow

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Scheduler  │    │   Backup    │    │   Gmail     │
│             │    │  Service    │    │   API       │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       │ 1. Trigger        │                   │
       ├──────────────────▶│                   │
       │                   │ 2. Get Messages  │
       │                   ├──────────────────▶│
       │                   │ 3. Message List  │
       │                   ◀──────────────────┤
       │                   │                   │
       │                   │ 4. Get Full Msgs  │
       │                   ├──────────────────▶│
       │                   │ 5. Message Data  │
       │                   ◀──────────────────┤
       │                   │                   │
       │                   │ 6. Parse & Format │
       │                   │                   │
       │                   │ 7. Generate MBOX │
       │                   │                   │
       │                   │ 8. Store Backup  │
       │                   │                   │
       │ 9. Update State   │                   │
       ◀──────────────────┤                   │
```

## Storage Architecture

```
backups/
├── users/
│   ├── user1@example.com/
│   │   ├── gmail/
│   │   │   ├── full/
│   │   │   │   ├── 2025-10-28_full.mbox
│   │   │   │   ├── 2025-10-28_full.mbox.gz
│   │   │   │   └── metadata.json
│   │   │   ├── incremental/
│   │   │   │   ├── 2025-10-29_inc.mbox
│   │   │   │   ├── 2025-10-29_inc.mbox.gz
│   │   │   │   └── metadata.json
│   │   │   └── state/
│   │   │       ├── backup_state.json
│   │   │       └── last_backup.json
│   │   ├── drive/
│   │   └── calendar/
│   └── user2@example.com/
├── logs/
│   ├── backup.log
│   ├── error.log
│   ├── audit.log
│   └── performance.log
├── temp/
│   └── processing/
│       ├── user1_temp/
│       └── user2_temp/
└── config/
    ├── backup_config.json
    └── user_permissions.json
```

## Error Handling Flow

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Backup    │    │   Error     │    │   Retry     │
│  Service    │    │  Handler    │    │  Manager    │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       │ 1. Error Occurs   │                   │
       ├──────────────────▶│                   │
       │                   │ 2. Classify Error │
       │                   │                   │
       │                   │ 3. Retryable?     │
       │                   ├──────────────────▶│
       │                   │ 4. Yes/No         │
       │                   ◀──────────────────┤
       │                   │                   │
       │ 5. Retry/Abort    │                   │
       ◀──────────────────┤                   │
       │                   │                   │
       │ 6. Log Error      │                   │
       ├──────────────────▶│                   │
       │                   │ 7. Notify User    │
       │                   │                   │
```

## Monitoring and Metrics

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Backup    │    │  Metrics    │    │  Monitoring │
│  Service    │    │ Collector   │    │  Dashboard  │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       │ 1. Send Metrics   │                   │
       ├──────────────────▶│                   │
       │                   │ 2. Process Data  │
       │                   │                   │
       │                   │ 3. Store Metrics │
       │                   │                   │
       │                   │ 4. Update Dashboard│
       │                   ├──────────────────▶│
       │                   │ 5. Display Data   │
       │                   │                   │
       │ 6. Get Status     │                   │
       ├──────────────────▶│                   │
       │ 7. Return Status  │                   │
       ◀──────────────────┤                   │
```

## Security Architecture

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│    User     │    │   Access    │    │ Encryption  │
│             │    │ Controller  │    │ Manager     │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       │ 1. Request        │                   │
       ├──────────────────▶│                   │
       │                   │ 2. Check Perms    │
       │                   │                   │
       │ 3. Allow/Deny     │                   │
       ◀──────────────────┤                   │
       │                   │                   │
       │ 4. Encrypt Data   │                   │
       ├──────────────────▶│                   │
       │                   │ 5. Encrypt        │
       │                   ├──────────────────▶│
       │                   │ 6. Encrypted      │
       │                   ◀──────────────────┤
       │ 7. Store Secure   │                   │
       ◀──────────────────┤                   │
```

---

**Document Version**: 1.0  
**Last Updated**: October 28, 2025  
**Task**: #1358 - Design Google MCP server architecture for automated backup
